いろいろ運用していて要件が生まれたがこれまでのバッチ方式では設計がフィットしないため考え直したい。

# フォローしているアーティストのアルバム一覧を巡回してニューリリースを取得したい

# 基本方針

ジョブキューに巡回スケジュールを登録し、そのスケジュールに基づいて巡回を行う。
これは依存しているAPIのレートリミットに達し、処理が途中で止まってしまうことがあるためである。
処理中に失敗したものは基本的には最初からやり直す。

# 巡回スケジュールの生成

巡回スケジュールはデータベースに登録する。
1日に1回、スケジュールを生成して登録する。
(RabbitMQも検討したのだが今回はスモールスタートな設計にしたい。)

## アーティストのアルバム取得

巡回対象のアーティストは毎日取得する。

## アルバムの詳細

アルバムの詳細は取得したアルバムに対して基本的には1度だけ行う。
スケジュールを作成する際には既に詳細情報を取得しているアルバムは除外する。

# フォローしているアーティストのアルバム一覧を取得

生成されたスケジュールに基づいてアーティストのアルバム一覧を取得する。

# アルバム詳細情報の取得

生成されたスケジュールに基づいてアルバムの詳細情報を取得する。

# 通知

通知はDBに保存し、管理する。

## 作成

- 過去n日でリリースされたもの
- 通知除外対象のレーベルではないこと

## 送信

- 未送信の通知を取得
- 通知を送信し、送信済みにする

# テーブル定義

## 前提

### すべてのテーブルには以下のカラムを持つ

- id
- created_at
- updated_at
- deleted_at
- lock_version

### データ型について

日時は `datetime` 型を使用する。
IDは `int` 型で、自動採番とする。
名前は `varchar` 型で、長さは `255` もしくは `512` とする。

### その他

テーブル名は単数形とする。
コメントは日本語で記述する。

## 作成するテーブル

### アーティスト

- アーティスト名
- Spotify上のアーティストID

### アルバム

- Spotify上のアルバムID
- アーティストID

### アルバム詳細

- アルバムID
- アルバム名
- リリース日時
- リリース日時タイプ
- リリースしたレーベル

### 通知

- アルバムID
- 通知送信日時
  - 未送信の場合はNULL

### アーティストアルバム取得スケジュール

- アーティストID
- スケジュール日時
- 実行開始日時
- 実行終了日時

### アルバム詳細取得スケジュール

- アルバムID
- スケジュール日時
- 実行開始日時
- 実行終了日時
